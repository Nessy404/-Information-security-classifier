<doc>
  <source auto="true" type="str" verify="true"><![CDATA[https://habr.com/ru/company/acribia/blog/430408/]]></source>
  <category auto="true" type="str" verify="true"><![CDATA[Информационная безопасность]]></category>
  <author auto="true" type="str" verify="true"><![CDATA[AAMinin]]></author>
  <title auto="true" type="str" verify="true"><![CDATA[Проверяем закрытую уязвимость и получаем четыре новые CVE]]></title>
  <keywords auto="true" type="list" verify="true">
    <item type="str"><![CDATA[Блог компании Акрибия]]></item>
    <item type="str"><![CDATA[Информационная безопасность]]></item>
  </keywords>
  <text auto="true" type="str" verify="true"><![CDATA[Меня попросили продолжить цикл статей про закрытие уязвимостей и про то, как их закрывают (нашу первую статью прочитать можно здесь ). В прошлый раз мы выяснили, что даже если производитель рапортует о закрытии уязвимости, то на деле все может быть и не так. Критерии отбора: Критерии отбора на рассматриваемые уязвимости в этот раз были такими же (за тем исключением, что в этот раз хотелось посмотреть на уязвимости другого типа): должен быть эксплойт – мы хотим посмотреть, что до обновления все было хорошо эксплуатируемо плохо, а после стало хорошо; уязвимость должна быть критичной (в идеале RCE) и с высоким score; продукт должен быть Open Source; продукт должен быть не заброшенным и активно используемым; уязвимость должна быть относительно новой; как и всегда, главное, чтобы нам самим было интересно. Что и как я выбирал: Я зашел на vulners.com и попросил показать все эксплойты с exploit-db.com за последние пару недель. В этот раз в категории «веб» почти все эксплойты были за авторством Ihsan Sencan, но из-за того, что чаще всего они относятся к sql-инъекциям в старых не поддерживаемых приложениях и плагинах, я их убрал. Из оставшихся продуктов в категорию «не заброшен и активно развивается» попал только ProjeQtOr Project Management Tool 7.2.5 с уязвимостью CVE-2018-18924. Данная уязвимость удовлетворила все критерии отбора: есть эксплойт ; уязвимость RCE (хоть и требует, чтобы пользователь был авторизован); продукт вполне себе Open Source; продукт не заброшен, за 2018 год было 28 релизов и только с sourceforge.net было 702 скачивания (причем большинство скачиваний обновления решающего проблему CVE, что, вероятнее всего, свидетельствует о том, что люди увидели CVE и стали обновлять); CVE от 4 ноября, эксплойт от 25 октября, это удовлетворяет требованиям новизны; я посмотрел на проблему и ее решение, мне стало интересно (об этом будет дальше). Разбираемся с ProjeQtOr Project Management Tool Читаем описание эксплойта и описание CVE на nist.gov , понимаем, что уязвима версия 7.2.5 только для авторизованного пользователя. А еще что в качестве изображения можно загрузить файл формата .shtml, на который хоть и будет высвечена ошибка “This file is not a valid image” , но файл все равно будет сохранен в изображения на сервере и доступен по прямой ссылке в host/files/images/image_name . Доступность по прямой ссылке это хорошо, но тут надо еще угадать имя, с которым файл будет загружен. Нам везет, и оно не случайное, а генерируется из текущего времени в формате: год, месяц, число, часы, минуты, секунды. В результате получается вот такое число 20181114140320. Дальше через нижнее подчеркивание идет ID пользователя, а затем оригинальное имя файла. Остается довольно много неизвестных: часовой пояс на сервере; не сбиты ли на сервере часы; ID пользователя. И вновь нам везет: если загрузить валидное изображение, то все эти параметры нам сообщат. Дальше пробежаться по нескольким вариантам ссылок не составит труда (несколько, так как есть секунды, а в них сразу попасть сложно). В целом получить имя файла не является проблемой. Двигаемся дальше. И думаем, почему бы не загрузить просто php-скрипт? Пытаемся его загрузить, выскакивает такое же окно, но файл не появляется в директории. Пора смотреть в код! За загрузку изображения на сервер отвечает скрипт uploadImage.php в версии 7.2.5 нас интересуют строки с 100 по 117. if (substr($ext, 0 , 3 )== 'php' or substr($ext, 0 , 4 )== 'phtm' ) { if (@!getimagesize($uploadedFile[ 'tmp_name' ])) { $error=i18n( 'errorNotAnImage' ); } else { traceHack( "Try to upload php file as image in CKEditor" ); } } else { if ( ! move_uploaded_file($uploadedFile[ 'tmp_name' ], $uploadfile)) { $error = htmlGetErrorMessage(i18n( 'errorUploadFile' , 'hacking ?' )); errorLog(i18n( 'errorUploadFile' , 'hacking ?' )); } }} if (!$error) { if (@!getimagesize($uploadfile)) { $error=i18n( 'errorNotAnImage' ); }} Строка 100 отвечает за проверку расширения файла: если оно php или phtm, то файл отбрасывается и не сохраняется. Поэтому php файлы не появляются в директории “files/images/”. Строка 115 создает ошибку, которую мы видим, но ничего не делает с файлом. Ну ладно, давайте не отходить от эксплойта и зальем файл с расширением .shtml. Тут стоит сделать небольшое отступление и рассказать, что такое .shtml и с чем его едят. SHTML и SSI Определение с википедии: SSI (Server Side Includes — включения на стороне сервера) — несложный язык для динамической «сборки» веб-страниц на сервере из отдельных составных частей и выдачи клиенту полученного HTML-документа. Реализован в веб-сервере Apache при помощи модуля mod_include. Включенная в настройках по умолчанию веб-сервера возможность позволяет подключать HTML-файлы, поэтому для использования инструкций файл должен оканчиваться расширением .shtml, .stm или .shtm. Своими словами: SHTML — это такой HTML, который может выполнять наборы команд на стороне сервера. Из полезного там есть функция exec, которая выполняет произвольные команды на сервере (да, мы можем кодом на HTML скачать файл и запустить его). Вот пример кода для запуска произвольного кода: <!-- #exec cmd=”ls” --> Хорошая новость в том, что этот функционал не включен по умолчанию на Apache2-сервере, а чтобы его включить надо потанцевать с бубном. За пару часов ковыряния конфига я смог заставить работать отдачу переменных окружения, но не команды. Вот мой SSI код: <html> <head> <title>thegeekstuff.com</title> </head> <body> <p> Today is <!-- #echo var="DATE_LOCAL" --> <!-- #exec cmd="ls" --> </p> </body></html>Его вывод:Today is Wednesday, 14 -Nov -2018 17 : 29 : 14 MSK [an error occurred while processing this directive] Если кто-то расскажет, что надо написать в конфиге, чтобы оно отработало корректно, я бы с радостью прочитал. Эксплуатируем уязвимость Если звезды сошлись, вы сможете загрузить shtml файл и выполнить произвольные команды (или как я, посмотреть время на сервере). Смотрим патч Следующая версия — 7.2.6, но в ней нет никаких изменений относительно интересующей нас уязвимости (nist.gov опять обманул). Смотрим версию 7.2.7 и там кажется, что все исправлено (сами разработчики говорят, что все исправлено как раз в этой версии). Ключевых изменений два: 1. Среди запрещенных расширений добавилось “shtm” (если первые 4 символа таких, сюда же попадает и shtml): if (substr($ext, 0 , 3 )== 'php' or substr($ext, 0 , 4 )== 'phtm' or substr($ext, 0 , 4 )== 'shtm' ) { 2. Файлы, которые не являются картинками, теперь удаляются: if (@!getimagesize($uploadfile)) { $error=i18n( 'errorNotAnImage' ); kill($uploadfile);} Казалось бы, можно расходиться, ведь некартинки удаляются, а shtml даже не пытается сохраниться. Но мне всегда не нравилось, если какую-то проблему пытаются решить черными списками. Для примера в некоторых странах компании запрещают соц.сети. Это приводит к тому, что пользователи начинают пользоваться “зеркалами” соц.сетей, где у них крадут логины и пароли. Пароли у них совпадают с корпоративными паролями, ну а дальше могут появиться куда большие проблемы, чем сотрудник, листающий инстаграмм за чашкой кофе. В веб-программировании и его безопасности черные списки тоже зло. Обходим черный список от ProjeQtOr Ну, тут все просто. Для начала смотрим, какие файлы при дефолтных настройках Apache2+PHP может интерпретировать (все ставилось на ubuntu 16.04 с обновленным репозиторием). За возможность интерпретировать файлы отвечает директива “FilesMatch”. Делаем поиск по ней командой “grep -r "<FilesMatch" /etc/apache2” и вот результат: /etc/apache2/mods-available/php7 .0 .conf:<FilesMatch ".+\.ph(p[3457]?|t|tml)$" >/etc/apache2/mods-available/php7 .0 .conf:<FilesMatch ".+\.phps$" >/etc/apache2/mods-available/php7 .0 .conf:<FilesMatch "^\.ph(p[3457]?|t|tml|ps)$" >/etc/apache2/sites-available/ default -ssl.conf: <FilesMatch "\.(cgi|shtml|phtml|php)$" >/etc/apache2/apache2.conf:<FilesMatch "^\.ht" > В конфиге default-ssl.conf все расширения просто перечислены целиком, это: cgi, shtml, phtml, php. Увы, но все кроме cgi отфильтровывается в ProjeQtOr. Куда интереснее конфиг php7.0.conf, в нем расширения заданы регулярным выражением. Получаем: Расширение Чем фильтруется php substr($ext,0,3)=='php' php3 substr($ext,0,3)=='php' php4 substr($ext,0,3)=='php' php5 substr($ext,0,3)=='php' php7 substr($ext,0,3)=='php' pht НИЧЕМ phtml3 substr($ext,0,4)=='phtm' Отлично, расширение файла, которое не фильтруется, найдено. Проверяем, что оно действительно интерпретируется. Создаем файл test.pht со следующим содержимым: <?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            